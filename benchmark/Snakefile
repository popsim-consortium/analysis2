"""
Snakefile for running DFE benchmark on stdpopsim.
"""

import numpy as np
import stdpopsim
import tskit


# ###############################################################################
# GENERAL RULES & GLOBALS
# ###############################################################################


def HuberDFE():
    """
    Return neutral and negative MutationType()s representing a human DFE.
    Huber et al. (2017)
    """
    neutral = stdpopsim.ext.MutationType()
    gamma_shape = 0.19  # shape
    gamma_mean = -0.014  # expected value
    h = 0.5  # dominance coefficient
    negative = stdpopsim.ext.MutationType(
        dominance_coeff=h,
        distribution_type="g",  # gamma distribution
        distribution_args=[gamma_mean, gamma_shape],
    )
    # neutral mutations have 0 proportion because they are not simulated by SLiM
    return {"mutation_types": [neutral, negative], "proportions": [0.0, 0.7]}

nreps = np.arange(2)

sim_results_pattern = "sim_OutOfAfrica_3G09_HuberDFE_{rep}rep.trees"

sim_results = expand(sim_results_pattern, rep=nreps)

rule all:
    input:
        sim_results

rule simulation:
    input:
    output:
        sim_results_pattern
    threads: 1
    run:
        species = stdpopsim.get_species("HomSap")
        model = species.get_demographic_model("OutOfAfrica_3G09")
        contig = species.get_contig("chr1", length_multiplier=0.001)
        contig.clear_genomic_mutation_types()
        samples = model.get_samples(100, 100, 100)  # YRI, CEU, CHB
        contig.add_genomic_element_type(
            intervals=np.array([[0, int(contig.recombination_map.sequence_length)]]),
            **HuberDFE(),
        )
        contig.mutation_rate = 2.35e-8
        engine = stdpopsim.get_engine("slim")
        ts = engine.simulate(
            model,
            contig,
            samples,
            seed=123,
            slim_scaling_factor=1,
            slim_burn_in=10,
        )
        ts.dump(output[0])


# ###############################################################################
# dadi/fitdadi
# ###############################################################################


rule generate_dadi_neu_fs:
    input: rules.simulation.output
    output:
    threads: 1
    run:

rule generate_dadi_nonneu_fs:
    input: rules.simulation.output
    output:
    threads: 1
    run:

#rule dadi_infer_dm:
#    input: rules.generate_dadi_neu_fs.output
#    output:
#    threads: 28
#    run:

#rule dadi_bestfit_dm:
#    input: rules.dadi_infer_dm.output

#rule dadi_generate_cache:
#    input: rules.dadi_bestfit_dm.output
#    output:
#    threads: 28
#    run:

#rule dadi_infer_dfe:
#    input: rules.generate_dadi_nonneu_fs.output

#rule dadi_bestfit_dfe:
#    input: rules.dadi_infer_dfe.output

#rule plot_dadi_results:
#    input: rules.dadi_bestfit_dfe.output


# ###############################################################################
# polyDFE
# ###############################################################################


#rule generate_polydfe_fs

#rule run_polydfe

#rule plot_polydfe_results


# ###############################################################################
# DFE-alpha
# ###############################################################################


#rule generate_dfe_alpha_fs

#rule run_dfe_alpha

#rule plot_dfe_alpha_results
